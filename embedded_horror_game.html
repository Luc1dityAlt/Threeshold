<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>THRESHOLD: LIDAR Horror</title>
<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  background: #000;
  color: #ccc;
  font-family: monospace;
}
#game {
  position: relative;
  width: 100%;
  height: 100%;
}
canvas {
  display: block;
}
#ui {
  position: absolute;
  top: 10px;
  left: 10px;
  z-index: 10;
  background: rgba(0,0,0,0.6);
  padding: 8px 12px;
  border: 1px solid #333;
}
#log {
  position: absolute;
  bottom: 0;
  width: 100%;
  max-height: 25%;
  overflow-y: auto;
  background: rgba(0,0,0,0.75);
  font-size: 12px;
  padding: 6px;
}
</style>
</head>
<body>
<div id="game">
  <canvas id="c"></canvas>
  <div id="ui">
    <div>Sanity: <span id="sanity">100</span></div>
    <div>Objective: <span id="objective">Use LIDAR (R) to scan</span></div>
  </div>
  <div id="log"></div>
</div>
<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
const logEl = document.getElementById('log');
const sanityEl = document.getElementById('sanity');
const objEl = document.getElementById('objective');

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

function log(msg) {
  const p = document.createElement('div');
  p.textContent = msg;
  logEl.appendChild(p);
  logEl.scrollTop = logEl.scrollHeight;
}

function rand(a,b){ return Math.random()*(b-a)+a; }
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }

const state = {
  time: 0,
  sanity: 100,
  messagesSeen: new Set(),
  lidarActive: false,
  lidarDots: []
};

const player = {
  x: 0,
  y: 0,
  angle: 0,
  speed: 0.022,
  rotSpeed: 0.035,
  fov: Math.PI/3
};

const MAP_SIZE = 32;
let map = [];

function generateMap() {
  map = Array.from({length: MAP_SIZE}, () => Array(MAP_SIZE).fill(1));
  let cx = Math.floor(MAP_SIZE/2);
  let cy = Math.floor(MAP_SIZE/2);
  map[cy][cx] = 0;

  for(let i=0;i<900;i++){
    map[cy][cx]=0;
    const d = Math.floor(rand(0,4));
    if(d===0) cx++;
    if(d===1) cx--;
    if(d===2) cy++;
    if(d===3) cy--;
    cx = clamp(cx,1,MAP_SIZE-2);
    cy = clamp(cy,1,MAP_SIZE-2);
  }

  map[cy][cx]=2;
  player.x = MAP_SIZE/2;
  player.y = MAP_SIZE/2;
}

generateMap();

const keys = {};
window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

canvas.addEventListener('click', () => {
  canvas.requestPointerLock();
});

document.addEventListener('mousemove', e => {
  if(document.pointerLockElement === canvas){
    player.angle += e.movementX * 0.002;
  }
});

function castRay(angle){
  let sin = Math.sin(angle);
  let cos = Math.cos(angle);
  let dist = 0;
  while(dist < 20){
    const x = player.x + cos*dist;
    const y = player.y + sin*dist;
    const tx = Math.floor(x);
    const ty = Math.floor(y);
    if(map[ty] && map[ty][tx] === 1) return dist;
    if(map[ty] && map[ty][tx] === 2) return dist;
    dist += 0.05;
  }
  return 20;
}

function update(dt){
  let dx = Math.cos(player.angle);
  let dy = Math.sin(player.angle);
  let speedMultiplier = keys['shift'] ? 2 : 1;

  if(keys['w']) tryMove(dx*player.speed*dt*speedMultiplier, dy*player.speed*dt*speedMultiplier);
  if(keys['s']) tryMove(-dx*player.speed*dt*speedMultiplier, -dy*player.speed*dt*speedMultiplier);
  if(keys['a']) player.angle -= player.rotSpeed*dt;
  if(keys['d']) player.angle += player.rotSpeed*dt;

  // LIDAR toggle
  if(keys['r'] && !state.lidarActive){
    state.lidarActive = true;
    state.lidarProgress = 0;
    state.lidarDots = [];
  }

  if(state.lidarActive){
    state.lidarProgress += dt*5;
    for(let i=0;i<360;i+=5){
      let angle = (i/180)*Math.PI + player.angle;
      let dist = castRay(angle);
      state.lidarDots.push({x: player.x+Math.cos(angle)*dist, y: player.y+Math.sin(angle)*dist});
    }
    if(state.lidarProgress>4){ state.lidarActive=false; }
  }
}

function tryMove(mx,my){
  const nx = player.x + mx;
  const ny = player.y + my;
  if(map[Math.floor(player.y)][Math.floor(nx)] !==1) player.x = nx;
  if(map[Math.floor(ny)][Math.floor(player.x)] !==1) player.y = ny;
}

function render(){
  ctx.fillStyle = '#000';
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // Draw LIDAR dots
  ctx.fillStyle = '#0f0';
  state.lidarDots.forEach(dot=>{
    const px = canvas.width/2 + (dot.x - player.x)*20;
    const py = canvas.height/2 + (dot.y - player.y)*20;
    ctx.fillRect(px, py, 2,2);
  });
}

let last = performance.now();
function loop(now){
  let dt = (now-last)/16;
  last = now;
  update(dt);
  render();
  requestAnimationFrame(loop);
}

log("Click to focus. WASD to move. Hold Shift to sprint. Press R to use LIDAR.");
requestAnimationFrame(loop);
</script>
</body>
</html>
